name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Minify CSS
        run: php scripts/minify_css.php

      - name: Deploy via rsync
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null

          SSH_CMD="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"

          # Deploy all project files (excluding storage DB and uploads)
          rsync -avz --delete \
            --exclude='storage/' \
            --exclude='public/img/uploads/*' \
            --exclude='public/img/blog/' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env' \
            --exclude='.deploy_key*' \
            --exclude='/config.php' \
            --exclude='/config.prod.php' \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='/scripts/download_images.php' \
            -e "$SSH_CMD" \
            ./ \
            $DEPLOY_USER@$SERVER_IP:/var/www/cdemsolutions/

          # Install composer dependencies on server
          $SSH_CMD $DEPLOY_USER@$SERVER_IP "cd /var/www/cdemsolutions && composer install --no-dev --no-interaction 2>/dev/null || true"

          # Ensure storage and uploads exist, fix permissions so deploy user can write
          $SSH_CMD $DEPLOY_USER@$SERVER_IP "sudo mkdir -p /var/www/cdemsolutions/storage /var/www/cdemsolutions/public/img/uploads && sudo chown -R $DEPLOY_USER:www-data /var/www/cdemsolutions/storage && sudo chmod 775 /var/www/cdemsolutions/storage && chmod 775 /var/www/cdemsolutions/public/img/uploads"

          # Run database setup (idempotent) â€” runs as deploy user who owns storage/
          $SSH_CMD $DEPLOY_USER@$SERVER_IP "cd /var/www/cdemsolutions && php scripts/setup_database.php"

          # Hand storage ownership to www-data so PHP-FPM can read/write the DB
          $SSH_CMD $DEPLOY_USER@$SERVER_IP "sudo chown -R www-data:www-data /var/www/cdemsolutions/storage && sudo chmod 775 /var/www/cdemsolutions/storage"

          echo "Deployed successfully!"
